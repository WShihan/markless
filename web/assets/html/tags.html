{{ define "style"}}
<link rel="stylesheet" href="{{$.Env.BaseURL}}/static/css/link_add.css" />
<link rel="stylesheet" href="{{$.Env.BaseURL}}/static/css/link_edit.css" />
<style>
  .tags {
    display: flex;
    gap: 1em;
    margin: 2em 0em;
  }
  .tag-box {
    display: flex;
    flex-direction: column;
    gap: 0.5em;
    margin: 1em auto;
    label {
      text-align: center;
    }
  }
  .tip {
    text-align: center;
  }
  .submit {
    width: 100%;
    margin: 2em auto;
  }
</style>
{{ end }} 

{{ define "content"}}
<div class="tag-update">
  <details open>
    <summary>{{ i18n "page.tags.detail.add.summary" $.Page.Lang }}</summary>
    <form action="{{$.Env.BaseURL}}/tag/add" method="post">
      <textarea type="text" name="tag" aria-multiline="true" placeholder="{{ i18n "page.tags.detail.add.placeholder" $.Page.Lang }}"></textarea>
      <button class="submit" type="submit" onclick="return confirm('{{ i18n "confirm.add" $.Page.Lang }}')">{{ i18n "button.add" $.Page.Lang }}</button>
    </form>
  </details>
  <details >
    <summary>{{ i18n "page.tags.detail.all.summary" $.Page.Lang }}</summary>
    <div class="tag-box">
      <label>{{ i18n "page.tags.detail.all.header" $.Page.Lang }}</label>
      <select id="current-tag" multiple="multiple" size="10">
        {{ range $key, $value := .Data }}
        <option value="{{$key}}">#{{$key}}</option>
        {{ end }}
      </select>
    </div>
    <div class="tip">
      <p>{{ i18n "page.tags.detail.all.tip" $.Page.Lang }}</p>
      <p>↓&nbsp;&nbsp;↑</p>
    </div>
    <div class="tag-box">
      <label>{{ i18n "page.tags.detail.delete.header" $.Page.Lang }}</label>
      <select id="all-tag" multiple="multiple" min-size="2"></select>
    </div>
    <input  id="tags" class="invisible" type="text" name="tags" value="" />
    <button class="submit" onclick="deleteTags(event)">{{ i18n "page.tags.detail.delete.header" $.Page.Lang }}</button>
  </details>

</div>

<script defer>
  let allTagEle = document.getElementById('all-tag')
  let curTagEle = document.getElementById('current-tag')
  let tagsEle = document.getElementById('tags')

  function changeTageItems(name, flag){
    let names = tagsEle.value.split(',')
    if (flag == 1){
      names.push(name)
    } else {
      names.splice(names.indexOf(name), 1)
    }
    tagsEle.value = names.join('&')
    console.log(tagsEle.value)
  }
  allTagEle.addEventListener('dblclick', function(e) {
    if(e.target instanceof HTMLSelectElement){
      return
    }
    curTagEle.appendChild(e.target)
    changeTageItems(e.target.value, 0)

  })
  curTagEle.addEventListener('dblclick', function(e) {
    if(e.target instanceof HTMLSelectElement){
      return
    }
    allTagEle.appendChild(e.target)
    changeTageItems(e.target.value, 1)
  })

  function deleteTags(){
    let tags = tagsEle.value
    if (tags == '') return
    if(!confirm('{{ i18n "confirm.delete" $.Page.Lang }}')) return
    fetch('{{$.Env.BaseURL}}/api/tag/delete/' + tags, {
      method: 'GET',
      cache: 'no-cache',
      credentials: 'include',
    }).then(res => res.json().then(data =>{
      const {status, msg} = data;
      if (status){
        window.location.reload()
      } else {
        alert(msg)
      }
    })).catch(err => {
      console.error('{{ i18n "msg.failed" $.Page.Lang }}', err)
    })
  }
</script>
{{ end }}
